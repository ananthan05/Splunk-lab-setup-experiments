##  Launching an Attack from Another PC in the LAN:

Let's start by clicking the "View Source" button on the bottom right of the challenge.

<img src="https://github.com/mrudnitsky/dvwa-guide-2019/blob/master/medium/screenshots/jssource.png" width="500">

We see that the Javascript code exists in the file <b>vulnerabilities/javascript/source/medium.js</b>, so let's check that source out too. We find the following code:

1 <code>function do_something(e){</code><br>
2 <code>  for(var t="",n=e.length-1;n>=0;n--)</code><br>
3 <code>    t+=e[n];</code><br>
4 <code>  return t</code><br>
5 <code>}</code><br>
6 <code>setTimeout(function(){</code><br>
7 <code>  do_elsesomething("XX")</code><br>
8 <code>},300);</code><br>
9 <code>function do_elsesomething(e){</code><br>
10 <code> document.getElementById("token").value=do_something(e+document.getElementById("phrase").value+"XX")</code><br>
11 <code>}</code><br>

Let's break down the code line-by-line:
<ol type="1">
  <li>This defines the function <code>do_something()</code>, which has one argument <code>e</code>.</li>
  <li>This iterates through <code>e</code> character-by-character in reverse order.</li>
  <li>This appends the current character to a new temporary string.</li>
  <li>This line returns the temporary string, which is <code>e</code> reversed.</li>
  <li>This closes out the <code>do_something()</code> function definition.</li>
  <li>This sets a timeout, which will execute the defined <code>function()</code> after a specified wait.</li>
  <li>This <code>function()</code> code calls the other function <code>do_elsesomething()</code>, defined below, with the argument "XX".</li>
  <li>This sets the timeout for <code>function()</code> to 300 milliseconds.</li>
  <li>This defines the function <code>do_elsesomething()</code>, which has one argument <code>e</code>. </li>
  <li>This sets the "token" value to the value returned by <code>do_something()</code> with an argument of <code>the input argument, concatenated with the value input into the challenge's form, concatenated with "XX"</code>.</li>
  <li>This closes out the <code>do_elsesomething()</code> function definition.</li>
</ol>

<h3><b>Crafting a New Exploit</b></h3>

All told, the above code sets the value of "token" to "XX" concatenated with the input form value, reversed, concatenated with "XX". So in order to win the challenge, we need to set "token" to "`XXsseccusXX`"!


Now, after creating the payload, intercept the request in Burp Suite after submitting it as 'success'.

![image](https://github.com/user-attachments/assets/a6d99e2e-51c7-4d5b-a1c0-ef263491a259)


Change the token from `token=XXeMegnahCXX` to `token=XXsseccusXX`. 

![image](https://github.com/user-attachments/assets/c40b65bc-ddaf-4512-b809-28c5d3797888)

then forward the request. The attack was successful.

![image](https://github.com/user-attachments/assets/910b54bc-111a-4cdf-b608-288119dde7d5)

## Next, we will detect the attack using Splunk

For this attack, we need to analyze the POST logs, which are not captured by default. So, we need to manually add logging code to the `medium.php` file in JavaScript

change the code to this so can get post logs in splunk.

```
<?php

// === [Start] Capture and Log POST Data ===
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $logfile = '/var/log/dvwa_post.log';

    $phrase = isset($_POST['phrase']) ? $_POST['phrase'] : '';
    $token = isset($_POST['token']) ? $_POST['token'] : '';
    $expected_token = strrev("XX" . $phrase . "XX");

    $ip = $_SERVER['REMOTE_ADDR'];
    $ua = isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';

    $log_line = "$ip | phrase=$phrase | token=$token | expected=$expected_token | ua=$ua\n";

    file_put_contents($logfile, $log_line, FILE_APPEND);
}
// === [End] Logging ===

$page['body'] .= '<script src="' . DVWA_WEB_PAGE_TO_ROOT . 'vulnerabilities/javascript/source/medium.js"></script>';
?>
```

 Check  if there's general activity on the JS vulnerability page.

```
index=main host="victim" "vulnerabilities/javascript"
```

![image](https://github.com/user-attachments/assets/d2ee0df9-aade-4b6b-a5d2-94ec188f3ed8)

We can see GET or POST requests to `/vulnerabilities/javascript/`, which indicates that users have interacted with this page.

```
index=main host="victim" "POST /DVWA/vulnerabilities/javascript/"
| table _time, _raw
```

![image](https://github.com/user-attachments/assets/c216687b-2d61-4335-a0d3-8aac366c0a4d)

Confirmed multiple POST requests. Now we know users submitted the form — likely trying to beat the JavaScript logic.

The default logs don’t show POST body content (phrase/token). So, we added a medium.php patch to log:

-The phrase (input)

-The token (generated by JavaScript or user)

-The user-agent and IP

```
index=main sourcetype="dvwa_post-too_small" host="victim"
| table _time, _raw
```

![image](https://github.com/user-attachments/assets/1a2f6754-c4db-424c-9413-7b43a562c3a1)

Which reveals exactly what users submitted — allowing us to detect tampering or bypassing.

WE break logs into structured fields, so we can compare what was entered (phrase) vs what was submitted as token, and what should have been expected.

```
index=main sourcetype="dvwa_post-too_small" host="victim"
| rex field=_raw "^(?<ip>\d{1,3}(?:\.\d{1,3}){3})"
| rex field=_raw "phrase=(?<phrase>\w+)"
| rex field=_raw "token=(?<token>\w+)"
| rex field=_raw "expected=(?<expected_token>\w+)"
| table _time, ip, phrase, token, expected_token

```

![image](https://github.com/user-attachments/assets/fb207255-0f09-4632-bc23-be43597c8de1)

We can now identify whether the token was valid or fake. This is the first step toward spotting a bypass.


The challenge uses JavaScript to reverse the input and surround it with "XX", forming a token. If someone submits a correct token without executing the JavaScript (e.g., by analyzing and crafting the logic manually), it’s a manual bypass.

```
index=main sourcetype="dvwa_post-too_small" host="victim"
| rex field=_raw "^(?<ip>\d{1,3}(?:\.\d{1,3}){3})"
| rex field=_raw "phrase=(?<phrase>\w+)"
| rex field=_raw "token=(?<token>\w+)"
| rex field=_raw "expected=(?<expected_token>\w+)"
| eval is_manual_bypass = if(token == expected_token, "✅ Manual JS bypass likely", "❌ Token mismatch or failed attempt")
| table _time, ip, phrase, token, expected_token, is_manual_bypass
```

![image](https://github.com/user-attachments/assets/33e3ad22-97e0-4924-b77a-b235d03f7f5b)

which means the attacker reverse-engineered and bypassed client-side JS validation.

Attack detected.


### After the POST log format changed , the previous command may no longer work. To adapt to the new structure, we need to try the following command instead.

```
index=main sourcetype="dvwa_post-too_small" host="victim1"
| spath path=ip output=ip
| spath path=post_data.token output=token
| spath path=post_data.phrase output=phrase
| eval expected_token = "XXsseccusXX"
| eval is_manual_bypass = if(token == expected_token, "✅ Manual JS bypass likely", "❌ Token mismatch or failed attempt")
| table _time, ip, phrase, token, expected_token, is_manual_bypass
```

![image](https://github.com/user-attachments/assets/71490c18-5be3-49b4-95a1-b8615efff7fc)
